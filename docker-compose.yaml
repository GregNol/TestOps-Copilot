version: '3.8'

networks:
  testops-network:
    driver: bridge

services:
  # Backend API - FastAPI на порту 8080
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: testops_api
    ports:
      - "8080:8080"
    networks:
      - testops-network
    environment:
      - PORT=8080
      - LLM_SERVICE_URL=http://llm:8081
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/api/v1/ai/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # LLM Service - внутренний сервис на порту 8081
  llm:
    build:
      context: ./llm_service
      dockerfile: Dockerfile
    container_name: testops_llm
    ports:
      - "8081:8081"
    networks:
      - testops-network
    environment:
      - PORT=8081
    env_file:
      - .env
    restart: unless-stopped
    # Порт НЕ пробрасываем наружу - только внутри сети
    # Порт НЕ пробрасываем наружу - только внутри сети

  # Frontend - статика через Nginx на порту 8082
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    container_name: testops_frontend
    networks:
      - testops-network
    restart: unless-stopped
    expose:
      - "8082"

  # Главный Nginx - reverse proxy
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: testops_nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - testops-network
    depends_on:
      - api
      - frontend
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/default.conf:/etc/nginx/http.d/default.conf:ro